events {

}

http {
    limit_req_zone $binary_remote_addr zone=lemmy.therhys.co.uk_ratelimit:10m rate=1r/s;
    map $http_upgrade $connection_upgrade {
	default upgrade;
	'' close;
    }
    
	upstream lemmy {
	    # this needs to map to the lemmy (server) docker service hostname
	    server "127.0.0.1:8536";
	}
	upstream lemmy-ui {
	    # this needs to map to the lemmy-ui docker service hostname
	    server "127.0.0.1:1234";
	}


  client_max_body_size 100M;
  send_timeout 10;

  

  server {
    listen 80;
    
    auth_basic	"Private";
    auth_basic_user_file htpasswd;
    server_name therhys.co.uk;

    location /jenkins {
	proxy_pass http://127.0.0.1:6060;
	proxy_http_version 1.1;

	# Required for Jenkins websocket agents
	proxy_set_header   Connection        $connection_upgrade;
	proxy_set_header   Upgrade           $http_upgrade;

	proxy_set_header   Host              $host;
	proxy_set_header   X-Real-IP         $remote_addr;
	proxy_set_header   X-Forwarded-For   $proxy_add_x_forwarded_for;
	proxy_set_header   X-Forwarded-Proto $scheme;
	proxy_max_temp_file_size 0;

	#this is the maximum upload size
	client_max_body_size       10m;
	client_body_buffer_size    128k;

	proxy_connect_timeout      90;
	proxy_send_timeout         90;
	proxy_read_timeout         90;
	proxy_buffering            off;
	proxy_request_buffering    off; # Required for HTTP CLI commands
	proxy_set_header Connection ""; # Clear for keepalive
    }

    location /management {
	proxy_pass https://127.0.0.1:9090;

        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Required for web sockets to function
        proxy_http_version 1.1;
        proxy_buffering off;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";

        # Pass ETag header from Cockpit to clients.
        # See: https://github.com/cockpit-project/cockpit/issues/5239
        gzip off;
	auth_basic off;
    }

    location /notes_api {
       proxy_pass http://127.0.0.1:41184;
       proxy_set_header X-Forwarded-Host $host:$server_port;
       proxy_set_header X-Forwarded-Server $host;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

       rewrite ^/notes_api(.*) $1 break; 

       proxy_redirect	off;
       proxy_set_header	Host	$host;

       auth_basic off;
    }

    
    location /notes {
       proxy_pass http://127.0.0.1:22300;
       proxy_set_header X-Forwarded-Host $host:$server_port;
       proxy_set_header X-Forwarded-Server $host;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

       rewrite ^/notes(.*) $1 break; 

       proxy_redirect	off;
       proxy_set_header	Host	$host;

       auth_basic off;
    }
 


    location /cloud {
       proxy_pass http://127.0.0.1:8000;
       proxy_set_header X-Forwarded-Host $host:$server_port;
       proxy_set_header X-Forwarded-Server $host;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
 
       auth_basic off;
       
       rewrite ^/cloud(.*) $1 break;
    }
    
    location /.well-known/carddav {
    	return 301 https://$host/cloud/remote.php/dav;
    	auth_basic off;
    }
    
    location /.well-known/caldav {
    	return 301 https://$host/cloud/remote.php/dav;
    	auth_basic off;
    }

    location /jackett {
       	proxy_http_version 1.1;
	proxy_set_header Upgrade $http_upgrade;
	proxy_set_header Connection $http_connection;       
	proxy_set_header X-Forwarded-Host $host:$server_port;
        proxy_set_header X-Forwarded-Server $host;

	proxy_pass http://127.0.0.1:9117;
    }

    location /dynmap {
	proxy_pass http://141.147.104.93;
        auth_basic off;
    }

    location /epc/ {
       proxy_pass http://127.0.0.1:3000;
       proxy_set_header X-Forwarded-Host $host:$server_port;
       proxy_set_header X-Forwarded-Server $host;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       proxy_set_header X-Request-Base "/epc/";

       rewrite ^/epc(.*) $1 break; 

       proxy_redirect	off;
       proxy_set_header	Host	$host;
       auth_basic off;
    }

    location /jellyfin {
       proxy_pass http://127.0.0.1:8096;

        proxy_pass_request_headers on;

        proxy_set_header Host $host;

        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header X-Forwarded-Host $http_host;

        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection $http_connection;

        # Disable buffering when the nginx proxy gets very resource heavy upon streaming
        proxy_buffering off;
	auth_basic off;
    }
    
    location /sonarr {
	proxy_http_version 1.1;
	proxy_set_header Upgrade $http_upgrade;
	proxy_set_header Connection $http_connection;       
	proxy_pass http://127.0.0.1:8989;
    }
    
    location /radarr {
	proxy_http_version 1.1;
	proxy_set_header Upgrade $http_upgrade;
	proxy_set_header Connection $http_connection;

       proxy_pass http://127.0.0.1:7878;
    }
    
     location /transmission {
              proxy_pass http://127.0.0.1:9091;
              proxy_pass_header X-Transmission-Session-Id;
              proxy_set_header Host $host;
              proxy_set_header X-Real-IP $remote_addr;
              proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
     }
     
     location / {
       proxy_pass http://127.0.0.1:8080;
       
      auth_basic off;
    }
  }

  server {
		listen 80;
		server_name lemmy.therhys.co.uk;
	# Hide nginx version
	    server_tokens off;

	    # Enable compression for JS/CSS/HTML bundle, for improved client load times.
	    # It might be nice to compress JSON, but leaving that out to protect against potential
	    # compression+encryption information leak attacks like BREACH.
	    gzip on;
	    gzip_types text/css application/javascript image/svg+xml;
	    gzip_vary on;

	    # Only connect to this site via HTTPS for the two years
	    add_header Strict-Transport-Security "max-age=63072000";

	    # Various content security headers
	    add_header Referrer-Policy "same-origin";
	    add_header X-Content-Type-Options "nosniff";
	    add_header X-Frame-Options "DENY";
	    add_header X-XSS-Protection "1; mode=block";

	    # Upload limit for pictrs
	    client_max_body_size 20M;

	    # frontend
	    location / {
		# distinguish between ui requests and backend
		# don't change lemmy-ui or lemmy here, they refer to the upstream definitions on top
		set $proxpass "http://lemmy-ui";

		if ($http_accept = "application/activity+json") {
		    set $proxpass "http://lemmy";
		}
		if ($http_accept = "application/ld+json; profile=\"https://www.w3.org/ns/activitystreams\"") {
		    set $proxpass "http://lemmy";
		}
		if ($request_method = POST) {
		    set $proxpass "http://lemmy";
		}
		proxy_pass $proxpass;

		rewrite ^(.+)/+$ $1 permanent;

		# Send actual client IP upstream
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header Host $host;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	    }

	    # backend
	    location ~ ^/(api|feeds|nodeinfo|.well-known) {
		proxy_pass "http://lemmy";
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection "upgrade";

		# Rate limit
		limit_req zone=lemmy.therhys.co.uk_ratelimit burst=30 nodelay;

		# Add IP forwarding headers
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header Host $host;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	    }

	    # pictrs only - for adding browser cache control.
	    location ~ ^/(pictrs) {
		# allow browser cache, images never update, we can apply long term cache
		expires 120d;
		add_header Pragma "public";
		add_header Cache-Control "public";

		proxy_pass "http://lemmy";
		proxy_http_version 1.1;
		proxy_set_header Upgrade $http_upgrade;
		proxy_set_header Connection "upgrade";

		# Rate limit
		limit_req zone=lemmy.therhys.co.uk_ratelimit burst=30 nodelay;

		# Add IP forwarding headers
		proxy_set_header X-Real-IP $remote_addr;
		proxy_set_header Host $host;
		proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
	    }

	    # Redirect pictshare images to pictrs
	    location ~ /pictshare/(.*)$ {
		return 301 /pictrs/image/$1;
	    }
  }
}
